<!-- This is a machine-generated file. To regenerate it, run: make docs -->
# RKE2 Support Bundle Format

Documentation for the structure and contents of RKE2 support bundles that r8s can analyze.

## Table of Contents
- [Overview](#overview)
- [Bundle Structure](#bundle-structure)
- [Supported Formats](#supported-formats)
- [Key Directories](#key-directories)
- [How r8s Parses Bundles](#how-r8s-parses-bundles)
- [Size Limits](#size-limits)
- [Known Variations](#known-variations)

---

## Overview

RKE2 support bundles are diagnostic archives generated by RKE2 clusters containing:
- kubectl resource dumps (pods, deployments, services, etc.)
- Pod and container logs
- System logs (journald, syslog, kern.log)
- Network diagnostics
- etcd health information
- Node system information

R8s parses these bundles to provide offline cluster analysis without requiring API access.

---

## Bundle Structure

### Standard RKE2 Bundle Layout

```
bundle-name/
├── collector-output.log          # Collection metadata
├── etcd/                         # etcd cluster health
│   ├── alarmlist
│   ├── endpointhealth
│   ├── endpointstatus
│   ├── memberlist
│   └── etcd-metrics-*.txt
├── journald/                     # systemd journal logs
│   ├── cloud-init
│   ├── rancher-system-agent
│   └── rke2-server
├── networking/                   # Network config/diagnostics
│   ├── iptables
│   ├── ip6tables
│   ├── ipaddrshow
│   ├── iproute
│   └── cni/
├── rke2/                         # RKE2-specific data
│   ├── version                   # RKE2 version info
│   ├── containerd.log           # Container runtime logs
│   ├── agent-logs/
│   │   └── kubelet.log
│   ├── crictl/                   # Container runtime interface dumps
│   │   ├── pods
│   │   ├── images
│   │   └── ps
│   ├── kubectl/                  # ⭐ Kubernetes resource dumps
│   │   ├── pods
│   │   ├── deployments
│   │   ├── services
│   │   ├── namespaces
│   │   ├── nodes
│   │   ├── crds
│   │   └── [other resources]
│   ├── podlogs/                  # ⭐ Container logs
│   │   ├── namespace-podname-container
│   │   ├── namespace-podname-container-previous
│   │   └── ...
│   └── pod-manifests/           # Static pod manifests
│       ├── kube-apiserver.yaml
│       ├── kube-controller-manager.yaml
│       └── kube-scheduler.yaml
├── systeminfo/                   # OS-level diagnostics
│   ├── cpuinfo
│   ├── meminfo
│   ├── hostname
│   ├── uptime
│   └── packages-dpkg
└── systemlogs/                   # System log files
    ├── syslog
    ├── kern.log
    └── ...
```

### Minimal Required Structure

R8s requires at minimum:

```
bundle-name/
└── rke2/
    ├── kubectl/     # At least one resource file
    └── podlogs/     # Optional but recommended
```

---

## Supported Formats

### Accepted File Types

| Format | Extension | Notes |
|--------|-----------|-------|
| **Extracted folder** | N/A | **Recommended** - no size limits |
| Gzipped tarball | `.tar.gz` | Most common, 50MB default limit |
| Tarball | `.tar` | Supported |
| Gzipped | `.tgz` | Supported |

### Not Supported

- `.zip` archives (use `.tar.gz` instead)
- `.7z` archives
- Encrypted archives
- Split/multi-volume archives

---

## Key Directories

### rke2/kubectl/

Contains YAML dumps of Kubernetes resources generated by `kubectl get <resource> -o yaml`.

**Important files r8s parses:**

| File | Content | Format |
|------|---------|--------|
| `pods` | All pods across namespaces | YAML stream |
| `deployments` | All deployments | YAML stream |
| `services` | All services | YAML stream |
| `namespaces` | All namespaces | YAML stream |
| `nodes` | All cluster nodes | YAML stream |
| `crds` | Custom Resource Definitions | YAML stream |
| `events` | Cluster events | YAML stream |

**Format example (pods file):**
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx-abc123
  namespace: default
spec:
  containers:
  - name: nginx
    image: nginx:latest
status:
  phase: Running
---
apiVersion: v1
kind: Pod
metadata:
  name: api-server-def456
  namespace: kube-system
# ... more pods
```

### rke2/podlogs/

Contains individual container log files.

**Naming convention:**
```
{namespace}-{podname}-{container}
{namespace}-{podname}-{container}-previous  # Crashed/restarted containers
```

**Examples:**
```
default-nginx-abc123-nginx
kube-system-coredns-xyz789-coredns
calico-system-calico-node-4lj7x-calico-node-previous
```

**Log format:**
```
2025-11-27T04:15:23.123Z [INFO] Starting nginx
2025-11-27T04:15:24.456Z [INFO] Listening on port 80
2025-11-27T04:15:25.789Z [WARN] Configuration file not found
```

### systemlogs/

System-level logs from the node.

| File | Content |
|------|---------|
| `syslog` | System log messages |
| `kern.log` | Kernel messages |
| `auth.log` | Authentication logs |

### journald/

Systemd journal exports for specific services.

| File | Service |
|------|---------|
| `rke2-server` | RKE2 server logs |
| `rke2-agent` | RKE2 agent logs |
| `rancher-system-agent` | Rancher system agent |
| `cloud-init` | Cloud-init execution |

---

## How r8s Parses Bundles

### Parse Sequence

1. **Extract** (if .tar.gz) → temporary directory
2. **Validate** bundle structure (check for `rke2/` directory)
3. **Parse manifest** → extract node name, versions, timestamps
4. **Inventory pods** → parse `rke2/kubectl/pods`
5. **Inventory logs** → scan `rke2/podlogs/` directory
6. **Parse resources** → load deployments, services, CRDs, namespaces
7. **Ready** → bundle loaded, TUI can navigate

### Data Extraction

**Pod inventory:**
- Parses `rke2/kubectl/pods` as YAML stream
- Extracts: namespace, name, status, containers
- Maps to log files in `rke2/podlogs/`

**Deployment inventory:**
- Parses `rke2/kubectl/deployments` as YAML stream
- Extracts: namespace, name, replicas, selector

**Log file inventory:**
- Scans `rke2/podlogs/` directory
- Parses filename to extract namespace/pod/container
- Determines log type (current vs previous)

### Defensive Parsing

R8s uses defensive parsing strategies:

- **Missing fields** → return empty string, don't crash
- **Malformed YAML** → skip entry, log warning if `--verbose`
- **Nil values** → safe extraction with fallbacks
- **Unknown structure** → best-effort parsing

See [`internal/bundle/safeget.go`](../../internal/bundle/safeget.go) for implementation.

---

## Size Limits

### Default Limits

| Type | Limit | Override |
|------|-------|----------|
| Extracted folder | Unlimited | N/A |
| .tar.gz file | 50MB | `--limit=<MB>` flag |
| .tar file | 50MB | `--limit=<MB>` flag |

### Why Size Limits?

1. **Memory safety** - Large bundles can consume significant RAM during extraction
2. **Performance** - Parsing 100MB+ of YAML is slow
3. **UX** - Prevent accidental processing of wrong files

### Overriding Limits

```bash
# Increase limit to 100MB
r8s tui --bundle=large-bundle.tar.gz --limit=100

# Unlimited (use with caution!)
r8s bundle info huge-bundle.tar.gz --limit=0

# Recommended: Extract first, then analyze
tar -xzf huge-bundle.tar.gz
r8s tui --bundle=./huge-bundle/
```

### What Happens When Exceeded?

```
Error: bundle size (75.4 MB) exceeds limit (50.0 MB)
Solution: Use --limit=80 to increase (e.g. 'r8s tui --bundle=bundle.tar.gz --limit=80')
```

---

## Known Variations

### RKE2 vs K3s Bundles

| Feature | RKE2 | K3s |
|---------|------|-----|
| Directory name | `rke2/` | `k3s/` |
| kubectl dumps | ✅ Supported | ⚠️  Partial support |
| Pod logs | ✅ Standard format | ⚠️  Different naming |
| System logs | ✅ Full | ✅ Full |

**Status:** r8s primarily supports RKE2 bundles. K3s support is experimental.

### Rancher vs kubectl Support Bundles

| Generated By | Structure | Support Level |
|--------------|-----------|---------------|
| `rke2 support-bundle` | Standard RKE2 | ✅ Full |
| Rancher UI download | May include additional metadata | ✅ Full |
| `kubectl cluster-info dump` | Different structure | ⚠️  Limited |
| Manual collection | Varies | ⚠️  Best effort |

### Version Differences

**RKE2 v1.28+:**
- Standard format
- Complete kubectl dumps
- Consistent naming

**RKE2 v1.27 and earlier:**
- May have different directory structure
- Some resource types missing
- R8s uses fallbacks

**Recommendations:**
- Generate bundles with latest RKE2 version
- Include `--verbose` flag when analyzing old bundles

---

## Troubleshooting Bundle Issues

### Bundle Not Recognized

**Error:**
```
Error: not a valid RKE2 bundle
Missing: rke2/ directory
```

**Solutions:**
1. Check you're pointing to the extracted folder (not parent)
2. Verify bundle was fully extracted
3. Confirm it's an RKE2 bundle (not K3s or kubectl dump)

### Empty or Incomplete Data

**Symptom:** TUI shows "No pods found" but bundle should have pods

**Causes:**
- `rke2/kubectl/pods` file is empty or missing
- YAML is malformed
- Bundle collection failed on source cluster

**Debug:**
```bash
# Check if pods file exists and has content
ls -lh bundle/rke2/kubectl/pods

# Try verbose mode
r8s tui --bundle=./bundle/ --verbose
```

### Parse Warnings

**Message:**
```
⚠️ Warning: Skipped 3 pod entries due to parse errors
```

**Meaning:** Some pod entries had malformed YAML, r8s skipped them

**Actions:**
- This is usually OK - r8s loads what it can
- Use `--verbose` to see details of skipped entries
- If many entries skipped, bundle may be corrupted

### Size Limit Issues

See [Size Limits](#size-limits) section above.

---

## Example Bundles

### Minimal Test Bundle

Create a minimal bundle for testing:

```bash
mkdir -p test-bundle/rke2/kubectl
mkdir -p test-bundle/rke2/podlogs

# Create simple pods YAML
cat > test-bundle/rke2/kubectl/pods << 'EOF'
apiVersion: v1
kind: Pod
metadata:
  name: nginx-test
  namespace: default
spec:
  containers:
  - name: nginx
    image: nginx:latest
status:
  phase: Running
EOF

# Create log file
echo "2025-11-27T10:00:00Z [INFO] Test log entry" > test-bundle/rke2/podlogs/default-nginx-test-nginx

# Analyze
r8s tui --bundle=./test-bundle/
```

### Real-World Bundle

Download example bundle:
```bash
# Extract included example
cd r8s/example-log-bundle/
tar -xzf w-guard-wg-cp-svtk6-lqtxw-2025-11-27_04_19_09.tar.gz

# Analyze
r8s tui --bundle=./w-guard-wg-cp-svtk6-lqtxw-2025-11-27_04_19_09/
```

---

## See Also

- [CLI Usage Guide](USAGE.md)
- [Troubleshooting Guide](../TROUBLESHOOTING.md)
- [RKE2 Documentation](https://docs.rke2.io/)
- [Bundle Generation Guide](https://docs.rke2.io/diagnostics/support_bundle)
